### 목적
LLM을 활용한 채팅 서비스 구축

### 첫번째 아키텍처
![[Pasted image 20250129224050.png]]
### 문제점 
서버의 역할이 너무 많다. (프론트코드도 줘야하고 DB에서 접근도 해야하고)
배포 할때 동일 서버 접근해야한다. (서버에러가 뜨면 어디서 문제인지 파악하기 어렵고 서버가 죽으면 전체 서비스가 다운)
확장성이 안좋다.(부하가 몰리는 쪽만 확장하고 싶은데 확장할수가 없다.)
### 해결법 - 서버의 역할 분리
프론트 / 백엔드로 구분해야한다.

### 두번째 아키텍처
![[Pasted image 20250129224300.png]]
프론트파일을 클라우드에 올려두면 됨
사용자가 많아지면 blob stroage를 스케일업하면 된다.
서버가 문제가 생기면 서버만 스케일업하면 된다.
### 나이진점
1. 확장성
	1. 사용자가 많아지면 blob stroage를 스케일업하면 된다.
	2. 서버가 문제가 생기면 서버만 스케일업하면 된다.
2. 유연성
	1. 서버만 신경쓰고 개발 및 배포
	2. 프론트만 개발 및 배포
3. 유지보수
	1. 프론트와 백엔드가 분리되어서 좋다. 적당히 구분해야한다.
	서버를 많이 나누면 힘들다.
### 문제점
1. 실시간 데이터 처리
	1. 통신 지연
		1. 채팅을 할때마다 HTTP 통신을 해야해서 핸드쉐이크를 해야하고 헤더도 많아진다. 
2. 네트워크 오버헤드
	1. 실시간 채팅은 왔다갔다해야하니까 헤더가 계속 생성해 불필요한 리소스를 낭비하게 된다. (한 헤더를 재활용하는 방식으로 바꿔야지 좋다.)


### 해결책
웹소켓(양방향 통신 프로토콜)
- 길하나만 뚫어놓고 그길만 쓰는것 (사전에 연결을 맺어놓고 그연결로 계속 통신)
- stateful한 통신
	- 서버가 먼저 데이터를 보낼 수 있다. 
	- HTTP는 기브앤테이크는 확실함
	- LLM은 답변 생성시간이 길어서 기존 HTTP를 쓰면 안정성면이 불안하다. 그렇기에 웹소켓을 사용해야한다.
### 세번째 아키텍처
![[Pasted image 20250129225128.png]]
유저와 서버사이에 웹소켓을 뒀음
### 나아진점
- 양방향 통신
	- 네트워크 오버헤드 감소
	- 통신시간 감소


### 문제점
- 서버의 역할 과다
	- 아직 부족한 확장성(서버가 아직 유저,AI,DB관리등 조금 할일이 많음)

### 4번째 아키텍처

![[Pasted image 20250129225335.png]]
서버를 3개로 나눔 
API(회원가입,인증인가) , Chatting(웹소켓), Agent server(에이전트를 접근해 답변을 받아내는 역할)

1. API는 사용자의 요청 받아서 요청을 검증하고 DB 저장
2. 받은 요청을 Agent(openai)를 보내서 에이전트에 보내서 답변을 받기
3. 가공되서 온 답변은 웹소켓을 통해 사용자에게 답변을 제공


### 나아진 점
- 확장성,유연성
- 기술 스택 선정 용이(여러가지 기술스택을 이용하더라도 호환이 된다)
- 접근 제어 세분화
- 세분화된 모니터링

### 문제점
- 서버간 데이터 송수신 어떻게? (HTTP를 사용하게 되면은 채팅한번에 3개의 서버를 거쳐가야함)
- 서버에 장애가 발생한다면? (메세지 유실이 되니까 유실복구에 용이하지않다) -> 메세지큐 MQ

- 메세지큐는 메세지를 보관하는 큐이다.

![[Pasted image 20250129225938.png]]
이렇게 하면 자원되는 낭비가 심하다.
![[Pasted image 20250129225951.png]]
- 서버간 통신을 지원하는 시스템
	- 메시지 전달/ 소비로 구성 (API server은 메세지 전달, Q를 보고 차례대로 Agent는 메세지를 소비하면 되는 구조가 된다. 그래서 유실되는게 조금 없어진다.)
	- 비동기 통신
	- 결합도 감소
	- 장애복구(유실감소)
### 최종 아키텍처
![[Pasted image 20250129230156.png]]



### Azure Function
- Serverless - 서버가 없다.
	- Faas , Function As A Service
	- 함수를 짜는 데만 집중해라 (비즈니스로직만 개발)
	- 쓴만큼만 돈 주면 되서 싼가격

![[Pasted image 20250129230516.png]]
콜드 스타트 (첫시작이 조금 늦음), Azure에 종속됨, 환경이 제한됨(지원하는 버전,언어만)

![[Pasted image 20250129230542.png]]
DB도 Azure COsmos DB
 - Serverless
	 - 사용한만큼만 요금 지불
	 - 콜드스타트문제 X


### 언어와 프레임워크
Server
- FastAPI/ python 3.11
- Node.js 20.14 (Azure 펑션 설치)
DB
- MongoDB 6.0 (파이썬 딕셔너리가 있어서 Nosql이랑 되게 잘맞는다 )