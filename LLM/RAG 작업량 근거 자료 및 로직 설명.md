기본 rag 기능 - 방대한 문서를 가지고 검색증강생성을 통해 사용자질문을 시멘틱서치를 하여 문서에서 원하는 문서를 가지고 올수있도록 해줌


셀프쿼리리트리버
기존 리트리버에서 메타데이터로 근거로 필터를 넣을수있음
필터를 통한 1차적인 문서를 필터하고 필터로 줄은 문서안에서 시멘틱서치를 통해 원하는 문서를 보다 더 정확한 문서를 가져올수있음 

 
 셀프쿼리리트리버 예시
![[스크린샷 2024-05-22 14.25.50.png]]

![[스크린샷 2024-05-22 14.26.01.png]]

![[스크린샷 2024-05-22 14.26.14.png]]

1. 기존rag에 넣을 데이터document타입에서 메타데이터를 활용 -  카테고리에 대한 메타데이터를 뽑아 기존데이터 가공 - 벡터 디비저장
2. metadata의 info를 입력하여 알게 한다. (name, description,type)형식이야함
3. 벡터디비와 문서의 내용설명 , 메타데이터의 설명, llm을 통해 리트리버를 생성한다.

기존 셀프쿼리리트리버에서 chain을 사용해서 다양한 라이브러리 커스텀을 활용해서 셀프쿼리리트리버 강화 - 보통은 셀프쿼리만 씀 

1. 메타데이터의 설명중 유니크한 값들에 대한 명시를 하여 필터의 퀄리티를 높일수있었음 
2. 중요한 부분 chain

```
from langchain.chains.query_constructor.base import ( #커스텀 쿼리 프롬프트 작성하기위해 기존

get_query_constructor_prompt,

load_query_constructor_runnable,

)
```

```
doc_contents = "견적에 대한 자세한 설명"

prompt = get_query_constructor_prompt(doc_contents, attribute_info)

print(prompt.format(query="{query}"))
```
커스텀 체인을 구현하여 프롬프트와 필터를 이용하여 현재 견적에 맞게 설정하게 됨



## 우리의 RAG 로직
### 랭체인라이브러리설치 
### 랭체인 loader를 이용하여 json파일읽기
### 유니코드데이터에서 분석을 위해 한글인코딩처리
### 파이썬 딕셔리너파일을  df으로 변환 (df로 분석을 위해 변경) 
### 숫자데이터를 문자열로 되있어서 숫자int타입으로 컨버터, 벤치마크순위등을 데이터전처리
### 필요없는 카테고리 제거  (title이나 판단하에 필요없는 카테고리 제거)
### attributeinfo를 추출하기위한 df.head를 뽑아서 카테고리에 대해 분석하여 설명을 붙이기 (메타데이터 생성) (name,description,type순으로)![[스크린샷 2024-05-28 14.56.45.png]]
### attributeinfo추가 (프롬프트에 추가하여 메타데이터의 정확성을 명시하게 됨)
![[스크린샷 2024-05-28 14.57.03.png]]
###  데이터 유니크한값은 attributeinfo에 명시하면 더 정확하게 알려줄수있음(분석한 유니크한값들을 메타데이터 설명에 추가하여 더 확실하게 명시하게 됨)  ![[스크린샷 2024-05-28 14.54.29.png]]

![[스크린샷 2024-05-28 14.55.08.png]]
### chain을 생성해서 커스텀 쿼리 프롬프트를 구현 
자세하게 이야기 
- attribute_info와 스키마를 설정하여(메타데이터카테고리에 대한 설명과 스키마 규칙을 설정 - 랭체인 공식문서를 참고하여 가능한 스키마를 추출한뒤에 그 스키마로 어떻게 메타데이터로 거를수있는지 생각후 스키마 규칙생성)
- 랭체인 공식문서 참고
![[스크린샷 2024-05-28 15.03.20.png]]

![[스크린샷 2024-05-28 15.03.37.png]]
- 이러한 허용 스키마를 찾아보고 여러문서를 참고하여 스키마 규칙생성

- 어떤 랭체인을 이용해서 커스텀했는지 
![[스크린샷 2024-05-28 14.58.15.png]]
![[스크린샷 2024-05-28 14.58.40.png]]
											스키마규칙  ,          메타데이터카테고리의설명
결국 스키마 규칙
![[스크린샷 2024-05-28 14.57.43.png]]
- get_query_constructor_prompt로 프롬프트 작성(스키마,attribute_info) -> load_query_constructor_runnable 위 커스텀 프롬프트로 실제로 필터와 쿼리를 생성하게끔 도와줌 ,커스텀 프롬프트를 참고하여 LLM이  필터생성해줌 ->
- ![[스크린샷 2024-05-28 14.59.36.png]]
- filter의 할루시네이션(query내용이 영어로 갑자기 바뀌거나 filter에서 300만원 이하일경우 100만원도 추천해주는거를 방지하기위해 더 명시적으로 프롬프트에 추가함
- 할루시네이션 예시 
![[스크린샷 2024-05-25 15.15.48.png]]

이런식으로 대표적인 명시를 통해 필터의 유효성을 올리게 됨 -> 다시 load_query_constructor_runnable을 이용하여 필터,쿼리예시까지 추가하여 체인생성 -> invoke를 통한 필터테스트![[스크린샷 2024-05-25 15.18.41.png]]->
필터의 정확도 상승 및 기존 가격에 대한 명시가 없어 170만원이하면 50만원도 보여주는 오류?가 떠서 리미트를 잡아 2,30만원에 대한 리미트를 설정하였기 때문에 저런 필터가 만들어짐 ->  



허깅페이스를 통한 gpu 임베딩모델설정
![[스크린샷 2024-05-28 15.05.49.png]]


현재 data_df에 있던 것을 document타입으로 설정하여 랭체인 인식이 되게끔 바꾸게 됨
![[스크린샷 2024-05-28 15.06.24.png]]


docs에는 document타입으로 변환된 견적데이터와 임베딩모델을 설정해서 chroma라이브러리를 이용하여 벡터디비를 임베딩하여 벡터디비만들게됨
![[스크린샷 2024-05-28 15.06.53.png]]
selfqueryretriever랭체인 라이브러리를 가져와 , 커스텀쿼리(체인)와 벡터디비,k값설정하여 리트리버설정 ![[스크린샷 2024-05-28 15.07.19.png]]리트리버를 통해 견적추천받기 
![[스크린샷 2024-05-28 15.07.56.png]]
![[스크린샷 2024-05-28 15.08.04.png]]



구현기간 : 약 3,4주
코드줄 : 
![[스크린샷 2024-05-28 18.18.59.png]]
약 1400줄